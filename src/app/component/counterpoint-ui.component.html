<div class="cp-wrapper" [class.dark]="_dark">
  <mat-card class="cp-card" [ngSwitch]="_activeTab">

    <div class="card-top">
      <h1 class="title">
        {{
          _activeTab === 'two'
            ? "Taneev's Vertical Shifting Counterpoint"
            : "Three-Voice Vertical Shifting Counterpoint"
        }}
      </h1>

      <button
        type="button"
        class="theme-toggle"
        (click)="toggleDark"
        [attr.aria-pressed]="_dark"
        [matTooltip]="_dark ? 'Switch to light mode' : 'Switch to dark mode'">
        <span aria-hidden="true">{{ _dark ? '‚òÄÔ∏è' : 'üåô' }}</span>
        <span class="sr-only">{{ _dark ? 'Light mode' : 'Dark mode' }}</span>
      </button>
      <div class="view-toggle" role="tablist" aria-label="View">
        <button
          class="toggle"
          role="tab"
          [attr.aria-selected]="_activeTab === 'two'"
          [class.active]="_activeTab === 'two'"
          (click)="_activeTab = 'two'">
          2-voice
        </button>
        <button
          class="toggle"
          role="tab"
          [attr.aria-selected]="_activeTab === 'three'"
          [class.active]="_activeTab === 'three'"
          (click)="_activeTab = 'three'">
          3-voice
        </button>
      </div>
    </div>

    <ng-container *ngSwitchCase="'two'">
      <div class="card-header"></div>

      <p class="subtitle">
        Enter a JV (inversion index) to see which intervals stay or switch between consonance and dissonance after
        inversion.
      </p>

      <div class="controls">
        <div class="control">
          <label for="jv">JV</label>
          <input id="jv" type="number" [(ngModel)]="_jvInput" (ngModelChange)="OnJvInput()"/>
        </div>
      </div>

      <div class="legend">
        <div class="legend-item"><span class="swatch fixedConsonant"></span> Fixed Consonances</div>
        <div class="legend-item"><span class="swatch fixedDissonant"></span> Fixed Dissonances</div>
        <div class="legend-item"><span class="swatch variableConsonant"></span> Variable Consonances</div>
        <div class="legend-item"><span class="swatch variableDissonant"></span> Variable Dissonances</div>
      </div>

      <div class="grid">
        <div
          *ngFor="let i of _indices"
          [ngClass]="getClassForIndex(i)"
          class="cell"
          [matTooltip]="'Interval ' + i"
        >
          <div class="glyph glyph-top"
               [ngClass]="_cells[i]?.topClass"
               [title]="_cells[i]?.topTitle">
            {{ _cells[i]?.topGlyph || '' }}
          </div>

          <div class="interval-number">{{ i }}</div>

          <div class="glyph glyph-bottom"
               [ngClass]="_cells[i]?.bottomClass"
               [title]="_cells[i]?.bottomTitle">
            {{ _cells[i]?.bottomGlyph || '' }}
          </div>

          <!-- imperfect ‚Üí perfect flag (2-voice) -->
          <span
            *ngIf="_cells[i]?.upgrade"
            class="ip-flag"
            [matTooltip]="'Imperfect consonance becomes perfect after JV'">
          </span>
        </div>
      </div>

      <div class="buckets">
        <div><strong>Fixed Consonances:</strong> {{ _invertedIntervals.fixedConsonances.join(', ') }}</div>
        <div><strong>Fixed Dissonances:</strong> {{ _invertedIntervals.fixedDissonances.join(', ') }}</div>
        <div><strong>Variable Consonances:</strong> {{ _invertedIntervals.variableConsonances.join(', ') }}</div>
        <div><strong>Variable Dissonances:</strong> {{ _invertedIntervals.variableDissonances.join(', ') }}</div>
      </div>
    </ng-container>

    <ng-container *ngSwitchCase="'three'">
      <p class="subtitle">
        Enter JV‚Ä≤ and JV‚Ä≥. JVŒ£ is computed as JV‚Ä≤ + JV‚Ä≥ (visualized below as three separate two-voice rows).
      </p>

      <div class="controls">
        <div class="control">
          <label for="jvPrime">JV‚Ä≤</label>
          <input id="jvPrime" type="number" [(ngModel)]="_jvPrimeInput" (ngModelChange)="onThreeVoiceInput()"/>
        </div>

        <div class="control">
          <label for="jvDoublePrime">JV‚Ä≥</label>
          <input id="jvDoublePrime" type="number" [(ngModel)]="_jvDoublePrimeInput"
                 (ngModelChange)="onThreeVoiceInput()"/>
        </div>

        <div class="control">
          <label for="jvSigma">JVŒ£</label>
          <input id="jvSigma" type="number" [value]="_jvSigmaView" readonly/>
        </div>
      </div>

      <h3 style="margin-top:10px">I ‚Üî II (JV‚Ä≤ = {{ _jvPrimeInput }})</h3>
      <div class="legend">
        <div class="legend-item"><span class="swatch fixedConsonant"></span> Fixed Consonances</div>
        <div class="legend-item"><span class="swatch fixedDissonant"></span> Fixed Dissonances</div>
        <div class="legend-item"><span class="swatch variableConsonant"></span> Variable Consonances</div>
        <div class="legend-item"><span class="swatch variableDissonant"></span> Variable Dissonances</div>
      </div>
      <div class="grid">
        <div
          *ngFor="let i of _indices"
          [ngClass]="getThreeRowClassForIndex(0, i)"
          class="cell"
          [matTooltip]="'Interval ' + i"
        >
          <div class="glyph glyph-top"
               [ngClass]="_threeRowsCells[0]?.[i]?.topClass"
               [title]="_threeRowsCells[0]?.[i]?.topTitle">
            {{ _threeRowsCells[0]?.[i]?.topGlyph || '' }}
          </div>
          <div class="interval-number">{{ i }}</div>
          <div class="glyph glyph-bottom"
               [ngClass]="_threeRowsCells[0]?.[i]?.bottomClass"
               [title]="_threeRowsCells[0]?.[i]?.bottomTitle">
            {{ _threeRowsCells[0]?.[i]?.bottomGlyph || '' }}
          </div>

          <!-- imperfect ‚Üí perfect flag (I‚ÜîII) -->
          <span
            *ngIf="_threeRowsCells[0]?.[i]?.upgrade"
            class="ip-flag"
            [matTooltip]="'Imperfect consonance becomes perfect after JV'">
          </span>
        </div>
      </div>
      <div class="buckets">
        <div><strong>Fixed Consonances:</strong> {{ _threeRows[0].fixedConsonances.join(', ') }}</div>
        <div><strong>Fixed Dissonances:</strong> {{ _threeRows[0].fixedDissonances.join(', ') }}</div>
        <div><strong>Variable Consonances:</strong> {{ _threeRows[0].variableConsonances.join(', ') }}</div>
        <div><strong>Variable Dissonances:</strong> {{ _threeRows[0].variableDissonances.join(', ') }}</div>
      </div>

      <hr>

      <h3>II ‚Üî III (JV‚Ä≥ = {{ _jvDoublePrimeInput }})</h3>
      <div class="legend">
        <div class="legend-item"><span class="swatch fixedConsonant"></span> Fixed Consonances</div>
        <div class="legend-item"><span class="swatch fixedDissonant"></span> Fixed Dissonances</div>
        <div class="legend-item"><span class="swatch variableConsonant"></span> Variable Consonances</div>
        <div class="legend-item"><span class="swatch variableDissonant"></span> Variable Dissonances</div>
      </div>
      <div class="grid">
        <div
          *ngFor="let i of _indices"
          [ngClass]="getThreeRowClassForIndex(1, i)"
          class="cell"
          [matTooltip]="'Interval ' + i"
        >
          <div class="glyph glyph-top"
               [ngClass]="_threeRowsCells[1]?.[i]?.topClass"
               [title]="_threeRowsCells[1]?.[i]?.topTitle">
            {{ _threeRowsCells[1]?.[i]?.topGlyph || '' }}
          </div>
          <div class="interval-number">{{ i }}</div>
          <div class="glyph glyph-bottom"
               [ngClass]="_threeRowsCells[1]?.[i]?.bottomClass"
               [title]="_threeRowsCells[1]?.[i]?.bottomTitle">
            {{ _threeRowsCells[1]?.[i]?.bottomGlyph || '' }}
          </div>

          <!-- imperfect ‚Üí perfect flag (II‚ÜîIII) -->
          <span
            *ngIf="_threeRowsCells[1]?.[i]?.upgrade"
            class="ip-flag"
            [matTooltip]="'Imperfect consonance becomes perfect after JV'">
          </span>
        </div>
      </div>
      <div class="buckets">
        <div><strong>Fixed Consonances:</strong> {{ _threeRows[1].fixedConsonances.join(', ') }}</div>
        <div><strong>Fixed Dissonances:</strong> {{ _threeRows[1].fixedDissonances.join(', ') }}</div>
        <div><strong>Variable Consonances:</strong> {{ _threeRows[1].variableConsonances.join(', ') }}</div>
        <div><strong>Variable Dissonances:</strong> {{ _threeRows[1].variableDissonances.join(', ') }}</div>
      </div>

      <hr>

      <h3>I ‚Üî III (JVŒ£ = {{ _jvSigmaView }})</h3>
      <div class="legend">
        <div class="legend-item"><span class="swatch fixedConsonant"></span> Fixed Consonances</div>
        <div class="legend-item"><span class="swatch fixedDissonant"></span> Fixed Dissonances</div>
        <div class="legend-item"><span class="swatch variableConsonant"></span> Variable Consonances</div>
        <div class="legend-item"><span class="swatch variableDissonant"></span> Variable Dissonances</div>
      </div>
      <div class="grid">
        <div
          *ngFor="let i of _indices"
          [ngClass]="getThreeRowClassForIndex(2, i)"
          class="cell"
          [matTooltip]="'Interval ' + i"
        >
          <div class="glyph glyph-top"
               [ngClass]="_threeRowsCells[2]?.[i]?.topClass"
               [title]="_threeRowsCells[2]?.[i]?.topTitle">
            {{ _threeRowsCells[2]?.[i]?.topGlyph || '' }}
          </div>
          <div class="interval-number">{{ i }}</div>
          <div class="glyph glyph-bottom"
               [ngClass]="_threeRowsCells[2]?.[i]?.bottomClass"
               [title]="_threeRowsCells[2]?.[i]?.bottomTitle">
            {{ _threeRowsCells[2]?.[i]?.bottomGlyph || '' }}
          </div>

          <!-- imperfect ‚Üí perfect flag (I‚ÜîIII / JVŒ£) -->
          <span
            *ngIf="_threeRowsCells[2]?.[i]?.upgrade"
            class="ip-flag"
            [matTooltip]="'Imperfect consonance becomes perfect after JV'">
          </span>
        </div>
      </div>
      <div class="buckets">
        <div><strong>Fixed Consonances:</strong> {{ _threeRows[2].fixedConsonances.join(', ') }}</div>
        <div><strong>Fixed Dissonances:</strong> {{ _threeRows[2].fixedDissonances.join(', ') }}</div>
        <div><strong>Variable Consonances:</strong> {{ _threeRows[2].variableConsonances.join(', ') }}</div>
        <div><strong>Variable Dissonances:</strong> {{ _threeRows[2].variableDissonances.join(', ') }}</div>
      </div>
    </ng-container>

  </mat-card>
</div>
